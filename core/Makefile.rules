PREFIX:=arm-none-eabi-
CC:=$(PREFIX)gcc
OBJCOPY:=$(PREFIX)objcopy
OBJDUMP:=$(PREFIX)objdump
GDB:=$(PREFIX)gdb

CORE:=../core

SYSTEM:=$(CORE)/system
LIB:=$(CORE)/lib
DEVICE:=$(CORE)/arch/$(ARCH)
SOURCES:=$(SYSTEM)/src/isr.c \
         $(LIB)/printf/tfp_printf.c \
         $(DEVICE)/src/system.c \
         $(APP_SRC)

DEBUG_HOST:=localhost
OPT:=-Os
DEBUG:=-g -DNDEBUG

FLAGS_CM3:=-mcpu=cortex-m3 -mthumb

LDFLAGS:=$(FLAGS_CM3) \
        -L$(CORE)/linker \
        -T$(CPU).ld \
        -nostartfiles \
        -nostdlib \
        -Xlinker --gc-sections \
        -Xlinker -M \
        -Xlinker -Map=$(PROJECT).map

CFLAGS:=$(OPT) $(DEBUG) $(FLAGS_CM3) \
        -ffunction-sections \
        -fdata-sections \
        -fno-common \
        -D$(CPU) \
        -I$(CORE)/cmsis/inc \
        -I$(CORE) -I$(SYSTEM)/inc -Iconfig \
        -I$(DEVICE)/inc \
        -I$(LIB)/printf \
        $(APP_CFLAGS)

OBJS:=$(SOURCES:.c=.o)

.PHONY: debug gdb gdbtui flash

all: $(PROJECT).bin

$(PROJECT).elf: $(OBJS)
	$(CC) $(LDFLAGS) -o $@ $^
	$(OBJDUMP) -d $@ > $(PROJECT).asm

$(PROJECT).bin: $(PROJECT).elf
	$(OBJCOPY) $< -O binary $@

gdb: gdb.script
	$(GDB) -x $<

gdbtui: gdb.script
	$(GDB)tui -x $<

gdb.script: $(PROJECT).elf
	echo -e "\
target remote $(DEBUG_HOST)\n\
monitor endian little\n\
monitor halt\n\
monitor speed 1000\n\
monitor flash device = $(CPU)\n\
load $<\n\
file $<\n\
monitor reset\n\
b main\n\
b default_handler\n\
" > $@

flash: gdb.flash
	$(GDB) -x $<

gdb.flash: $(PROJECT).elf
	echo -e "\
target remote $(DEBUG_HOST)\n\
monitor endian little\n\
monitor halt\n\
monitor speed 1000\n\
monitor flash device = $(CPU)\n\
load $<\n\
monitor reset\n\
quit\n\
" > $@

clean:
	rm -f $(PROJECT).map $(PROJECT).elf $(PROJECT).bin $(PROJECT).asm gdb.script gdb.flash
	find . $(CORE) -iname '*.o' -exec rm -f \{\} \;
